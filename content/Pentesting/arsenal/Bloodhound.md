---
tags:
  - 渗透/内网
  - 渗透/武器库
---

## 启动

```bash
$ sudo neo4j console (or sudo neo4j start, run in the background)
$ bloodhound
```

## 在Linux收集

### [BloodHound.py](https://github.com/fox-it/BloodHound.py)

```shell
TimeLess613@htb[/htb]$ sudo bloodhound-python -u 'forend' -p 'Klmcargo2' -ns 172.16.5.5 -d inlanefreight.local -c all 

TimeLess613@htb[/htb]$ ls
20220307163102_computers.json  20220307163102_domains.json  20220307163102_groups.json  20220307163102_users.json

# Upload the Zip File into the BloodHound GUI
$ zip -r ilfreight_bh.zip *.json
```


## 在Windows收集

### SharpHound

```powershell-session
PS C:\htb> .\SharpHound.exe -c All --zipfilename ILFREIGHT
```


## 利用

选择起点用户，在 `Node Info` 选项卡选择下面的 `Outbound Control Rights`（或 `OUTBOUND OBJECT CONTROL`）。或枚举主机用户，设置有价值用户然后查找最短路径等。

> [!note] Outbound Control Rights
> This option will show us objects we have control over directly, via group membership, and the number of objects that our user could lead to us controlling via ACL attack paths under `Transitive Object Control`. If we click on the `1` next to `First Degree Object Control`, we see the first set of rights that we enumerated, `ForceChangePassword` over the `damundsen` user.

> [!note] 右键Bloodhound的边（Edge），会显示帮助菜单。

> [[ACL#^596e57|Bloodhound的文档说明]]




## Raw Query - Cypher

> we can use the Analysis tab to run queries against the database.
> These queries can be custom and specific to what you decide using [custom Cypher queries](https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/).

搜RDP组

搜description：
```Cypher
MATCH (u:User) WHERE u.description IS NOT NULL RETURN u.name,u.description
```

搜索可以使用WinRM（`Remote Management Users`组）的用户：
```cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:CanPSRemote*1..]->(c:Computer) RETURN p2
```

搜索有`SQLAdmin`权限的用户：
```cypher
MATCH p1=shortestPath((u1:User)-[r1:MemberOf*1..]->(g1:Group)) MATCH p2=(u1)-[:SQLAdmin*1..]->(c:Computer) RETURN p2
```


### 踩坑

- GUI的Raw Query不一定能搜全，但是浏览器连接Neo4j数据库可以搜。据说可能是版本不同导致，但是试了下还是不行。



### 用Neo4j的Cypher搜索

Bloodhound GUI的Raw Query似乎不能return函数，所以想这样做时可以直接在Neo4j的console搜：

http://localhost:7474/
```Cypher
MATCH (n:User)
WHERE n.hasspn = true
RETURN COUNT(n) AS userCount
```
- `n`是一个自定义的变量。

了解Neo4j数据库结构：
```Cypher
CALL db.labels()
CALL db.propertyKeys()
```
- **标签（Labels）**：类似于 SQL 中的表，表示节点的类别或类型。
- **属性（Properties）**：类似于 SQL 中的列，表示节点或关系的具体数据字段。


